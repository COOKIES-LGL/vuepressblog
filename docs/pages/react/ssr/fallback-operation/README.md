---
title: 架构与降级
---
当页面 SSR 发生异常时会首先尝试降级，降级失败则兜底错误提示页，防止页面对用户白屏。

## 架构综述

总体上看，用户流量经 GBLB 网关至内网，前端服务分层降级遵循三个阶段：

在集群内部，Node 服务端渲染 (SSR) 偶发失败，自动降级为客户端静态渲染 (CSR) ，此过程我们称之为**降级渲染** ([后文展开论述](#降级渲染)) ；

业务服务在平台部署提供了多区部署能力 (腾讯云和百度云)，当某个集群发生故障时，会自动将流量切换到另一个分区；

当服务集群整体异常且短时间内无法恢复时（底层基础架构重大故障），此时将流量切至不依赖任何服务 404 页面，防止客户端端页面彻底白屏；

## 主要架构

将Cluster集群展开论述：

用户发起节页面加载请求时，流量自上而下依次经以下分层：

**1\. GBLB 网关：**
用户流量经防火墙 (WAF) 后至 GBLB/PBLB ，本层主要功能为多区负载均衡、服务超时、熔断、鉴权、风控拦截、UA 解析、灰度、预发/颜色流量分配、重定向等；<br />
**2\. 网关：**
基于函数级的请求转发、负载均衡、超时、多活、熔断、与函数 ABTest 与灰度，对接 PNS 获取实例地址，对接 Monitor 监控函数状态；<br />
**3\. K8S 业务集群：** K8S Pod 是应用高可用的核心区域和独立部署单元，从左至右依次为：
1. **探活服务**：监听 Pod 应用的健康状态，若 Pod 存活探测连续失败，则实例会被重启。金丝雀探活配置见：健康检查时延
2. **内置 Nginx 服务**：主要用于业务及路由转发、兜底、渲染降级的规则配置；
3. **SSR 应用服务**，从上至下为：<br />
  a. PM2 进程管理：Node 服务的进程管理、自动拉活、负载均衡；<br />
  b. Node 服务：负责同构渲染中的服务端渲染阶段的 NodeJS 容器。是前端请求体系中最复杂、最核心的部分，负责请求解析，后端数据获取与序列化后，动态返回 HTML 模板；<br />
  c. Sidecar 服务：如果 Node 服务请求 Java 后端的 HTTP 接口，请求会被实例的 Sidecar 进行风控加签并转发到 GBLB 请求对应的后端接口；<br />

**4\. CSR 静态服务**：
在 SSR 渲染任何一个环节失败时，Nginx 用静态页面替代本应该用 NodeJS 动态渲染的模板；如前文所述，此过程称为降级渲染。

## 降级渲染

商家主站 (Web微前端) 、移动端 H5 ( SSR ) 降级，是指用户请求在服务端渲染阶段发生的异常情况，无法正确返回动态 HTML 内容的时刻，可返回静态 HTML 模板，在客户端/浏览器内完成渲染过程的技术处理。

降级渲染的本质是「时间换空间」，即前端页面请求返回的整个声明周期中，当服务渲染阶段失败时，在用户端内渲染阶段尝试二次渲染作为补救措施。用户侧的表现为用户观测到内容渲染完成的时机 (Largest Contentful Paint) 明显延迟，而二者页面可交互时间 (Time To Interactive) 无太大差异。

造成降级的原因可能有：偶发的服务端渲染失败，如后端接口偶发超时或错误、命中风控、服务 QPS 被打满等，将上图中 K8S 示例分情况展开，则为下图的优化渲染路径 (左半部分) 与降级渲染路径 (右半部分) 两个方面：

### 优化渲染路径

在所有服务均保持健康的前提下，用户发起的页面请求经鉴权后转发至业务网关 (如骤1) ，跟进路由转发规则至由 PM2 + NodeJS + Sidecar 组成的 SSR 套件，具体为: PM2「进程管理服务」监听的多个 NodeJS 服务示例并做好负载均衡 (步骤2) ，Node 根据业务经 Sidecar 代理，异步发起1至多个数据请求 (步骤3) ，后端服务事务处理完毕，将数据返回至 SSR 套件 (步骤4) ， NodeJS 将数据序列化后，以动态模板的方式返回给 Nginx 应用服务器 (步骤5) ，后由 Nginx 返回动态模板 (步骤6) 。

任意环节失败时，都会导致服务端渲染错误导致页面白屏。

::: tip
* 导致白屏的因素：
1. 步骤1，因低版本 BApp 不支持 SSR 导致渲染错误；
2. 步骤2，因 Node 服务启动失败或进程被 Kill 返回错误，导致白屏；
3. 步骤3，因 Node 服务 QPS 过高或其他导致请求超，造成页面白屏；
4. 步骤4，因服务请求接口 (偶发或服务异常引发的) 超时错误，导致页面无数据；
5. 步骤5，因服务端返回的数据接口失败，或在数据序列化过程 (Serialization Process) 失败，导致服务器崩溃，造成白屏；
6. 步骤6，因前端模板拼接渲染失败抛出异常，导致页面白屏
:::

针对以上场景，前端平台架构中做好降级渲染路径兜底，以保证业务页面不会白屏。

### 降级渲染路径

降级渲染路径的过程在上图右侧图中清晰明了：当 K8S 内置 Nginx 在步骤5未能获取动态模板时，通过步骤6返回 Pod 已内置好的静态模板。与优化渲染路径不同的是，静态模板获取业务数据的时机（步骤9、10）发生在用户获取模板（步骤8）之后，因此前端页面载入时，不可避免地出现 Loading 态，顺延首屏渲染的时机，这也是降级渲染性能不如优化渲染的主要原因。

渲染降级得以实现的技术前提，是每个业务 Node 服务上线前，前端框架将都会提前编译好一份与之对应的静态前端模板，部署在同一个 Pod 实例内。

值得一提的是，对于单一业务依赖多接口渲染页面，可做到对页面局部接口与组件精细化降级。用以下两个示例讲解。

下面展示了接口命中风控局部降级渲染：当业务某接口 (视频中左上角第一个推荐商品位) 命中风控时，页面整体仍用服务端渲染，前端组件使用局部骨架图占位。通过客户端再次发起请求，发起风控挑战，挑战通过后组件局部渲染，无需页面整体刷新。

下面展示了接口偶发报错示意图：当业务某接口 (视频中左上角第一个推荐商品位) 接口请求失败时，与命中风控类似，页面整体仍用服务端渲染，前端组件局部骨架图占位，客户端再次发起数据请求自动渲染，体验上，用户几乎感觉不到页面接口发生过异常。

## 手动配置降级

某些场景下，我们可能希望用户访问时直接降级到 CSR。

### 基于特定系统、App 版本降级

支持 `downgrade` 配置对特定版本进行降级

:::caution 注意
BApp 4.5.2 以下版本不支持 SSR，因此在创建项目模版时，已经默认生成了 downgrade 配置。
:::

### 固定部分页面默认 CSR

可通过配置页面的 `server.config.js` 配置部分页面走 CSR 模式渲染
## 异常重启

### PM2 异常重启

使用 PM2 管理 NodeJS 实例，PM2 能够在同一个容器内启动多个 Node 进程最大化利用机器性能，同时能为多进程 Node 提供负载均衡、进程异常自动重启等能力，默认情况下，当实例 CPU、内存超过上限，或 NodeJS 进程断开时能够自动重启服务，对业务无感知。
